name: Publish Core Package

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: pypi

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Install uv
      uses: astral-sh/setup-uv@v5

    - name: Extract package version
      id: version
      run: |
        VERSION=$(grep 'version =' packages/core/pyproject.toml | sed -n 's/.*version = "\(.*\)"/\1/p')
        echo "Extracted version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build package
      run: uv build --package comfygit-core --no-sources

    - name: Publish to PyPI
      run: uv publish --trusted-publishing automatic
