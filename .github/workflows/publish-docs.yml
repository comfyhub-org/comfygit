name: Publish Documentation

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout monorepo
      uses: actions/checkout@v4
      with:
        persist-credentials: false
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.x"

    - name: Install MkDocs dependencies
      run: |
        pip install mkdocs mkdocs-material mkdocs-redirects mkdocs-git-revision-date-localized-plugin

    - name: Build documentation
      working-directory: docs/comfygit-docs
      run: |
        mkdocs build --site-dir ../../build-output
        echo "âœ“ Documentation built successfully"

    - name: Clone Pages repository
      run: |
        git clone https://${{ secrets.DOCS_PUBLISH_TOKEN }}@github.com/comfyhub-org/comfyhub-org.github.io.git pages-repo
        echo "âœ“ Pages repository cloned"

    - name: Deploy to /comfygit/ subdirectory
      run: |
        # Configure git for the Pages repo
        cd pages-repo
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Remove old comfygit docs
        rm -rf comfygit/
        echo "âœ“ Removed old comfygit/ directory"

        # Create comfygit directory and copy new docs
        mkdir -p comfygit/
        cp -r ../build-output/* comfygit/
        echo "âœ“ Copied new documentation to comfygit/"

        # Ensure CNAME exists at root (for custom domain)
        if [ ! -f CNAME ]; then
          echo "docs.comfyhub.org" > CNAME
          echo "âœ“ Created CNAME file"
        fi

        # Ensure hub index.html exists at root (will be added manually first time)
        if [ ! -f index.html ]; then
          echo "âš  Warning: index.html not found at root - hub landing page missing"
        fi

    - name: Commit and push changes
      working-directory: pages-repo
      run: |
        git add .

        if git diff --staged --quiet; then
          echo "â„¹ No changes to commit"
        else
          git commit -m "Deploy ComfyGit docs from ${{ github.sha }}

          Source: comfyhub-org/comfygit
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}

          ğŸ¤– Auto-deployed by GitHub Actions"

          git push
          echo "âœ“ Changes pushed successfully"
        fi

    - name: Deployment summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ComfyGit Documentation Deployed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Live URL: https://docs.comfyhub.org/comfygit/"
        echo "ğŸ“¦ Source: docs/comfygit-docs/"
        echo "ğŸ¯ Target: comfyhub-org.github.io/comfygit/"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Allow 1-2 minutes for GitHub Pages to rebuild."
        echo "Visit https://docs.comfyhub.org/comfygit/ to view."
