# dev/docker-compose.yml
services:
  # Development container for testing CEC
  cec-dev:
    build:
      context: ../
      dockerfile: docker/dev/Dockerfile.cec-dev
      args:
        UID: "${USER_UID:-1000}"
        GID: "${USER_GID:-1000}"
    volumes:
      # Mount entire CEC package directory
      - ../packages/cec:/workspace/cec
      # Mount test environments
      - ./test-environments:/env
      # WSL fix
      - /usr/lib/wsl:/usr/lib/wsl
    environment:
      # UV configuration
      - UV_CACHE_DIR=/env/uv_cache
      - UV_PYTHON_INSTALL_DIR=/env/uv/python
      - UV_PROJECT_ENVIRONMENT=/opt/venv
      - UV_LINK_MODE=hardlink
      # Python paths
      # - PYTHONPATH=/workspace/cec/src
      # ComfyGit specific
      - COMFYGIT_CACHE=/env/comfygit_cache
    working_dir: /workspace/cec
    stdin_open: true
    tty: true
    user: "${USER_UID:-1000}:${USER_GID:-1000}"
    ports:
      - "8188:8188"
    # GPU support
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # Override command for development
    command: ["/bin/bash"]

  # Alternative CEC dev with full workspace mount (for cross-package development)
  cec-workspace-dev:
    build:
      context: ../
      dockerfile: docker/dev/Dockerfile.cec-dev
      args:
        UID: "${USER_UID:-1000}"
        GID: "${USER_GID:-1000}"
    volumes:
      # Mount entire workspace
      - ../:/workspace/comfydock
      # Exclude all virtual environments
      - /workspace/comfydock/.venv
      - /workspace/comfydock/packages/cec/.venv
      - /workspace/comfydock/packages/core/.venv
      - /workspace/comfydock/packages/server/.venv
      - /workspace/comfydock/packages/cli/.venv
      # Mount test environments
      - ./test-environments:/env
      # Cache mount
      - uv-cache:/home/comfy/.cache/uv
    environment:
      - UV_CACHE_DIR=/home/comfy/.cache/uv
      - UV_PROJECT_ENVIRONMENT=/workspace/comfydock/packages/cec/.venv
      - PYTHONPATH=/workspace/comfydock/packages/cec/src
      - COMFYGIT_CACHE=/env/comfygit_cache
    working_dir: /workspace/comfydock/packages/cec
    stdin_open: true
    tty: true
    user: "${USER_UID:-1000}:${USER_GID:-1000}"
    command: ["/bin/bash"]

  # Server development (update similarly if needed)
  server-dev:
    build:
      context: ../docker/dev
      dockerfile: Dockerfile.server-dev
    volumes:
      - ../packages:/workspace/packages:ro
      - ./environments:/data/environments
      - ./caches:/data/caches
    ports:
      - "8000:8000"
    environment:
      - COMFYGIT_ENV_DIR=/data/environments
      - COMFYGIT_CACHE_DIR=/data/caches/comfygit

  # Frontend development
  frontend-dev:
    build:
      context: ../packages/frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ../packages/frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://server-dev:8000

  # Production-like ComfyUI container for testing
  comfyui-prod:
    build:
      context: ../
      dockerfile: docker/base/Dockerfile
    volumes:
      - ./test-environments/env/environments/test_env_1:/app
    ports:
      - "8189:8188"  # Different port to avoid conflicts
    environment:
      - COMFYUI_PATH=/app/ComfyUI
    entrypoint: ["/bin/bash", "-c", "sleep infinity"]

# Named volumes for persistent caches
volumes:
  uv-cache:
    driver: local